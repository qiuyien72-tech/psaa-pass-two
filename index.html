<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†°ç®±å°ç®¡å®¶</title>
    <style>
      /* --- åŸºç¤æ¨£å¼ --- */
      body { font-family: sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
      
      /* --- ç™»å…¥ç•«é¢ --- */
      #loginOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #f4f7f6; z-index: 9999;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
      }
      .login-box {
        background: white; padding: 40px; border-radius: 15px; width: 85%; max-width: 320px;
        text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      }
      .login-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #3498db; }
      
      .login-input {
        width: 100%; padding: 15px; margin-bottom: 20px; box-sizing: border-box;
        border: 2px solid #ccc; border-radius: 8px; font-size: 20px; text-align: center;
        text-transform: uppercase; font-weight: bold;
      }
      
      .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
      .btn-blue { background-color: #3498db; color: white; }
      .btn-white { background-color: white; color: #3498db; border: 2px dashed #3498db; }
      .btn-blue:disabled, .btn-white:disabled { background-color: #ccc; border-color: #ccc; color: #666; cursor: not-allowed; }

      /* --- ä¸»ç¨‹å¼ç•«é¢ --- */
      #appContainer { display: none; }
      .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; }
      
      .header-area { text-align: center; margin-bottom: 20px; position: relative; }
      .code-badge { background: #eee; padding: 5px 10px; border-radius: 15px; font-size: 14px; display: inline-block; font-weight: bold; cursor: pointer;}
      .logout-btn { position: absolute; right: 0; top: 0; font-size: 13px; color: red; cursor: pointer; background: #fff0f0; padding: 5px 10px; border-radius: 5px; }

      input.app-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
      /* ğŸ” æœå°‹æ¡†æ¨£å¼ */
      input.search-input { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #3498db; border-radius: 30px; box-sizing: border-box; font-size: 16px; background-color: #f0f8ff; color: #333; }
      input.search-input::placeholder { color: #88a; }

      .btn-row { display: flex; gap: 10px; margin-bottom: 15px;}
      
      .card { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; }
      .card-img { width: 60px; height: 60px; background: #eee; border-radius: 5px; margin-right: 15px; object-fit: cover; }
      .card-info { flex: 1; }
      .tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; color: white; margin-top: 5px; display: inline-block; }
      .bg-red { background: #e74c3c; } .bg-yellow { background: #f39c12; } .bg-green { background: #2ecc71; }
      
      /* ç³»çµ±ç‹€æ…‹ç‡ˆ */
      #systemStatus { position: fixed; bottom: 10px; right: 10px; font-size: 12px; background: white; padding: 5px 10px; border-radius: 20px; border: 1px solid #ccc; color: red; }
    </style>
  </head>
  <body>

    <div id="loginOverlay">
      <div class="login-box">
        <div class="login-title">ğŸ§Š å†°ç®±å°ç®¡å®¶</div>
        <p>åªèƒ½ä½¿ç”¨ç³»çµ±ç”¢ç”Ÿçš„ä»£ç¢¼ç™»å…¥</p>
        
        <input type="text" id="spaceCodeInput" class="login-input" placeholder="è¼¸å…¥ä»£ç¢¼">
        
        <button id="btnLogin" class="btn btn-blue" onclick="processLogin()">ğŸš€ ç™»å…¥ç©ºé–“</button>
        <button id="btnCreate" class="btn btn-white" onclick="processRegister()">ğŸ² ç”¢ç”Ÿæ–°ä»£ç¢¼</button>
      </div>
    </div>

    <div id="appContainer">
      <div class="container">
        <div class="header-area">
          <h3>æˆ‘çš„å†°ç®±</h3>
          <div class="code-badge" onclick="copyCode()">ä»£ç¢¼: <span id="displayCode"></span> (é»æ­¤è¤‡è£½)</div>
          <div class="logout-btn" onclick="logout()">ç™»å‡º</div>
        </div>
        
        <input type="text" id="inName" class="app-input" placeholder="ğŸ åç¨±">
        <input type="text" id="inLoc" class="app-input" placeholder="ğŸ§Š ä½ç½® (ä¾‹å¦‚: å†°ç®±)">
        <input type="date" id="inDate" class="app-input">
        
        <div id="previewBox" style="display:none; text-align:center;">
           <img id="imgPreview" src="" style="height:80px; border-radius:5px;">
           <div style="font-size:12px; color:#aaa;">å·²é¸åœ–</div>
        </div>

        <div class="btn-row">
          <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect()">
          <button class="btn btn-blue" style="background:#f39c12;" onclick="document.getElementById('fileInput').click()">ğŸ“· æ‹ç…§</button>
          <button class="btn btn-blue" style="background:#2ecc71;" onclick="saveData()">ğŸš€ åŠ å…¥</button>
        </div>
        
        <div id="statusLog" style="text-align:center; color:blue; margin:5px 0;"></div>

        <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹åç¨±æˆ–ä½ç½®..." onkeyup="filterData()">

        <div id="listArea"></div>
      </div>
    </div>

    <div id="systemStatus">ğŸ”´ è¼‰å…¥ä¸­...</div>

    <script>
      var allFoodData = [];
      var currentUserCode = ""; 

      // ------------------------------------
      // ğŸ‘‡ æ‚¨å¯ä»¥åœ¨é€™è£¡ä¿®æ”¹ã€Œè­¦å‘Šå¤©æ•¸ã€
      // ç›®å‰è¨­å®šï¼šå‰© 7 å¤©æœƒè®Šé»ƒè‰²ã€‚æ”¹æˆ 3 å°±æœƒå‰© 3 å¤©æ‰è®Šè‰²ã€‚
      const WARNING_DAYS = 7; 
      // ------------------------------------

      window.onload = function() {
        try {
          var savedCode = localStorage.getItem('mySpaceCode');
          if (savedCode) {
            verifyAndLogin(savedCode, true);
          }
          document.getElementById('systemStatus').innerHTML = "ğŸŸ¢ ç³»çµ±æ­£å¸¸";
          document.getElementById('systemStatus').style.color = "green";
        } catch (e) {
          document.getElementById('systemStatus').innerHTML = "ğŸ”´ éŒ¯èª¤: " + e.message;
        }
      };

      // --- ç™»å…¥èˆ‡è¨»å†Š ---
      function processLogin() {
        var input = document.getElementById('spaceCodeInput').value.trim().toUpperCase();
        if (!input) { alert("è«‹è¼¸å…¥ä»£ç¢¼"); return; }
        
        var btn = document.getElementById('btnLogin');
        btn.innerText = "ğŸ” é©—è­‰ä¸­...";
        btn.disabled = true;

        verifyAndLogin(input, false);
      }

      function verifyAndLogin(code, isAutoLogin) {
        google.script.run
          .withSuccessHandler(function(isValid) {
             var btn = document.getElementById('btnLogin');
             btn.innerText = "ğŸš€ ç™»å…¥ç©ºé–“";
             btn.disabled = false;

             if (isValid) {
               currentUserCode = code;
               localStorage.setItem('mySpaceCode', currentUserCode);
               showApp();
             } else {
               if (!isAutoLogin) alert("âŒ ç„¡æ•ˆçš„ä»£ç¢¼ï¼");
               if (isAutoLogin) localStorage.removeItem('mySpaceCode');
             }
          })
          .withFailureHandler(function(e) {
             alert("é€£ç·šéŒ¯èª¤: " + e);
             document.getElementById('btnLogin').disabled = false;
          })
          .checkCodeValid(code);
      }

      function processRegister() {
        var btn = document.getElementById('btnCreate');
        btn.innerText = "â³ è¨»å†Šä¸­...";
        btn.disabled = true;

        google.script.run
          .withSuccessHandler(function(newCode) {
             document.getElementById('spaceCodeInput').value = newCode;
             alert("ğŸ‰ è¨»å†ŠæˆåŠŸï¼ä»£ç¢¼: " + newCode);
             currentUserCode = newCode;
             localStorage.setItem('mySpaceCode', currentUserCode);
             showApp();
             btn.innerText = "ğŸ² ç”¢ç”Ÿæ–°ä»£ç¢¼";
             btn.disabled = false;
          })
          .withFailureHandler(function(e) {
             alert("ç”¢ç”Ÿå¤±æ•—: " + e);
             btn.disabled = false;
          })
          .createNewSpace();
      }

      function showApp() {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('displayCode').innerText = currentUserCode;
        loadData(); 
      }

      function logout() {
        localStorage.removeItem('mySpaceCode');
        currentUserCode = "";
        allFoodData = [];
        
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginOverlay').style.display = 'flex';
        
        document.getElementById('spaceCodeInput').value = "";
        document.getElementById('listArea').innerHTML = "";
        document.getElementById('searchInput').value = ""; 
      }

      function copyCode() {
        navigator.clipboard.writeText(currentUserCode);
        alert("å·²è¤‡è£½ï¼");
      }

      // --- è³‡æ–™æ“ä½œ ---
      function log(msg) { document.getElementById('statusLog').innerText = msg; }
      function handleFileSelect() {
        var file = document.getElementById('fileInput').files[0];
        if (file) {
          var reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('imgPreview').src = e.target.result;
            document.getElementById('previewBox').style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      }

      function loadData() {
        log("è®€å–ä¸­...");
        google.script.run.withSuccessHandler(function(data) {
             allFoodData = data || [];
             renderList(allFoodData);
             log("");
          }).withFailureHandler(function(e){ log("éŒ¯èª¤: " + e); }).getFoodListV3(currentUserCode); 
      }

      function saveData() {
        var name = document.getElementById('inName').value;
        var loc = document.getElementById('inLoc').value;
        var date = document.getElementById('inDate').value;
        var fileInput = document.getElementById('fileInput');
        if (!name || !date) { alert("è«‹è¼¸å…¥åç¨±å’Œæ—¥æœŸ"); return; }
        
        var send = function(base64) {
             log("å„²å­˜ä¸­...");
             google.script.run.withSuccessHandler(function(){
               log("æˆåŠŸï¼"); 
               setTimeout(function(){ log(""); }, 2000);
               document.getElementById('inName').value = "";
               document.getElementById('inLoc').value = "";
               document.getElementById('inDate').value = "";
               document.getElementById('fileInput').value = "";
               document.getElementById('previewBox').style.display = 'none';
               document.getElementById('searchInput').value = ""; 
               loadData(); 
            }).addFoodV3(currentUserCode, name, loc, date, base64);
        };
        if (fileInput.files.length > 0) compressImage(fileInput.files[0], send);
        else send(null);
      }
      
      function deleteItem(rowId, name) {
        if (!confirm("åˆªé™¤ã€Œ" + name + "ã€ï¼Ÿ")) return;
        log("åˆªé™¤ä¸­...");
        google.script.run.withSuccessHandler(function() {
             log("å·²åˆªé™¤");
             setTimeout(function() {
                 loadData();
                 document.getElementById('searchInput').value = "";
             }, 500);
          }).deleteFood(rowId);
      }

      function filterData() {
        var keyword = document.getElementById('searchInput').value.toLowerCase();
        
        var filtered = allFoodData.filter(function(item) {
           return item.name.toString().toLowerCase().includes(keyword) || 
                  item.location.toString().toLowerCase().includes(keyword);
        });
        
        renderList(filtered);
      }
      
      function renderList(data) {
        var listArea = document.getElementById('listArea');
        var html = "";
        if (!data || data.length === 0) {
          listArea.innerHTML = "<p style='text-align:center; color:#999;'>æš«ç„¡è³‡æ–™</p>";
          return;
        }
        data.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        data.forEach(function(item) {
           var imgHtml = (item.imgUrl && item.imgUrl.startsWith('http')) 
             ? `<img src="${item.imgUrl}" class="card-img">` : `<div class="card-img" style="display:flex;justify-content:center;align-items:center;">ç„¡åœ–</div>`;
           
           // è‡ªå‹•è¨ˆç®—å¤©æ•¸ (æ¯å¤©æ‰“é–‹éƒ½æœƒè®Š)
           var today = new Date(); today.setHours(0,0,0,0);
           var targetDate = new Date(item.date);
           var diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
           
           var statusClass = "bg-green"; var statusText = "æ–°é®®";
           
           // åˆ¤æ–·é‚è¼¯
           if (diffDays < 0) { 
               statusClass = "bg-red"; statusText = "éæœŸ " + Math.abs(diffDays) + " å¤©"; 
           } else if (diffDays <= WARNING_DAYS) { // ä½¿ç”¨ä¸Šæ–¹çš„è¨­å®šå€¼
               statusClass = "bg-yellow"; statusText = "å‰© " + diffDays + " å¤©"; 
           }

           html += `
             <div class="card">
               ${imgHtml}
               <div class="card-info">
                 <div style="font-weight:bold;">${item.name}</div>
                 <div style="font-size:14px; color:#666;">ğŸ“ ${item.location}</div>
                 <div class="tag ${statusClass}">${statusText}</div>
                 <div style="font-size:12px; color:#aaa;">${item.date}</div>
               </div>
               <button onclick="deleteItem(${item.rowId}, '${item.name}')" style="width:30px; background:none; color:red; border:1px solid #eee;">ğŸ—‘</button>
             </div>`;
        });
        listArea.innerHTML = html;
      }

      function compressImage(file, callback) {
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
          var img = new Image();
          img.src = event.target.result;
          img.onload = function() {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            var maxWidth = 500; var width = img.width; var height = img.height;
            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
            canvas.width = width; canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL('image/jpeg', 0.5).split(',')[1]);
          };
        };
      }
    </script>
  </body>
</html>